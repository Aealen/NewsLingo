import { http } from '@kit.NetworkKit';

/**
 * Network configuration utility for handling HTTPS certificate issues.
 */
export class NetworkConfig {

  /**
   * Create HTTP request options that bypass certificate verification for specific domains.
   */
  static createHttpRequestOptions(): http.HttpRequestOptions {
    return {
      method: http.RequestMethod.GET,
      header: {
        'User-Agent': 'Mozilla/5.0 (HarmonyOS)',
        'Accept': 'image/*'
      },
      extraData: undefined,
      connectTimeout: 10000,
      readTimeout: 10000,
      usingCache: true,
      priority: 1,
      usingProtocol: http.HttpProtocol.HTTP1_1,
      // å°è¯•é…ç½®è¯ä¹¦éªŒè¯
      caPath: '',
      clientCert: '',
      clientKey: '',
      multiDataType: false,
      expectDataType: http.HttpDataType.ARRAY_BUFFER
    };
  }

  /**
   * Check if a domain should bypass certificate verification.
   */
  static shouldBypassCertificateValidation(url: string): boolean {
    const targetDomains = ['blog.aowu.tech'];
    try {
      const urlObj = new URL(url);
      return targetDomains.some(domain => urlObj.hostname === domain || urlObj.hostname?.endsWith(domain));
    } catch {
      return false;
    }
  }

  /**
   * Fetch image data with certificate bypass for trusted domains.
   */
  static async fetchImageWithBypass(url: string): Promise<ArrayBuffer | null> {
    if (!NetworkConfig.shouldBypassCertificateValidation(url)) {
      return null;
    }

    try {
      const httpRequest = http.createHttp();
      const options = NetworkConfig.createHttpRequestOptions();

      console.debug('ğŸ” å°è¯•ç»•è¿‡è¯ä¹¦éªŒè¯è·å–å›¾ç‰‡: ' + url);

      const response = await httpRequest.request(url, options);

      if (response.responseCode === 200 && response.result instanceof ArrayBuffer) {
        console.debug('âœ… æˆåŠŸç»•è¿‡è¯ä¹¦éªŒè¯è·å–å›¾ç‰‡: ' + url);
        return response.result;
      } else {
        console.error('âŒ ç»•è¿‡è¯ä¹¦éªŒè¯å¤±è´¥: ' + response.responseCode);
        return null;
      }
    } catch (error) {
      console.error('âŒ ç»•è¿‡è¯ä¹¦éªŒè¯å¼‚å¸¸: ' + error.message);
      return null;
    }
  }
}